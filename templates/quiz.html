{% extends "base.html" %}
{% block title %}Quiz | Bootcamp Post-Test{% endblock %}
{% block content %}
<div class="card p-3" id="quiz-root"
     data-deadline="{{ deadline_ts|int }}"
     data-disabled="{{ 1 if disabled else 0 }}">
  <div class="d-flex justify-content-between align-items-center">
    <h4 class="m-0">üìù Quiz (Multiple Choice)</h4>
    <div class="timer" id="quiz_timer">‚è≥ --:--</div>
  </div>
  <hr/>

  <form method="post" id="quiz-form">
    {% for q in questions %}
      <div class="mb-3">
        <label class="form-label"><strong>{{ loop.index }}.</strong> {{ q.question }}</label>

        {% for c in q.choices %}
          {% set opt_id = q.id ~ '_' ~ loop.index0 %}
          <div class="form-check">
            <input class="form-check-input" type="radio" name="{{ q.id }}" id="{{ opt_id }}" value="{{ c }}">
            <label class="form-check-label" for="{{ opt_id }}">{{ c }}</label>
          </div>
        {% endfor %}
      </div>
    {% endfor %}

    <button class="btn btn-primary" id="quiz_submit">‚úÖ Kumpulkan Quiz</button>
  </form>
</div>

<script>
(() => {
  const root        = document.getElementById('quiz-root');
  const form        = document.getElementById('quiz-form');
  const timerEl     = document.getElementById('quiz_timer');
  const submitBtn   = document.getElementById('quiz_submit');
  const radios      = root.querySelectorAll('input[type="radio"]');

  const deadlineSec = root ? parseInt(root.dataset.deadline, 10) : 0;
  const preDisabled = root ? root.dataset.disabled === '1' : false;
  const endMs       = deadlineSec * 1000;

  const setDisabled = (state) => {
    if (submitBtn) submitBtn.disabled = state;
    radios.forEach(r => r.disabled = state);
    if (state && submitBtn) submitBtn.textContent = 'Waktu habis';
  };

  // Terapkan kondisi awal dari server
  setDisabled(preDisabled);

  const tick = () => {
    if (!endMs) return; // tidak ada deadline -> tanpa timer
    const left = Math.max(0, Math.floor((endMs - Date.now()) / 1000));
    const m = String(Math.floor(left / 60)).padStart(2, '0');
    const s = String(left % 60).padStart(2, '0');
    if (timerEl) timerEl.textContent = `‚è≥ ${m}:${s}`;
    if (left <= 0) setDisabled(true); else setTimeout(tick, 1000);
  };

  tick();
})();
</script>
{% endblock %}
